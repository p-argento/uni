UP TO NOW 
Data Warehouse: Data Models and DW Design and Implementation.

STARTING TODAY 
Data Analysis Using SQL.  How to summarize data using SQL?  What if the query takes a long time to produce the answer?

# dsd15 - Analytic SQL (1)
OLAP systems. Data Analysis Using SQL. Simple reports. Examples. Moderately Difficult Reports. Solutions in SQL.

> Maybe read https://en.wikipedia.org/wiki/Data_warehouse

OLAP refers to the technique of performing complex business  multidimensional analysis over the data warehouse.
> We will see how report developers use SQL to write queries!

## JRS exercise

**EXERCISE AT HOME**

![[Pasted image 20250107120447.png]]

In JRS, Options > Show Logical Plan.

Query 1.
Number of distinct customers by product.
```SQL
SELECT FkProduct, COUNT(DISTINCT(FkCustomer)) AS NCustomers
FROM Invoices, InvoiceLines
WHERE FkInvoiceNo=PkInvoiceNo
GROUP BY FkProduct;
```

Query 2.
Largest invoice revenue by product.
(for every product,  we want to know the total revenue of the invoice containing that product with the highest)

```SQL
WITH TotalByInvoice AS
	(SELECT FkInvoiceNo AS Invoice, SUM(FkProduct * Qty) AS TotalInvoice
	FROM InvoiceLines
	GROUP BY FkInvoiceNo)

SELECT FkProduct, MAX(TotalInvoice)
FROM InvoiceLines, TotalByInvoice
WHERE FkInvoiceNo=Invoice
GROUP BY FkProduct;
```

Query 3.
The percentage of revenue generated by the product over the total revenue of the customer by Customer and Product.

```SQL
WITH
a AS
	(
	SELECT FkCustomer, FkProduct, SUM(Price* Qty) AS Revenue
	FROM InvoiceLines, Invoices
	WHERE FkInvoiceNo=PkInvoiceNo
	GROUP BY FkCustomer, FkProduct
	),
b AS
	(
	SELECT FkCustomer, SUM(Price* Qty) AS Revenue
	FROM InvoiceLines, Invoices
	WHERE FkInvoiceNo=PkInvoiceNo
	GROUP BY FkCustomer
	)

SELECT a.FkCustomer, FkProduct,
	100*a.Revenue / b.Revenue AS pct
FROM a,b
WHERE a.FkCustomer=b.FkCustomer;
```

This is a very complicated version of the query that can be simplified using the extended SQL that we see today.

## Reporting Solutions
UP TO NOW 
Data Warehouse: Data Models and DW Design and Implementation.

STARTING TODAY 
Data Analysis Using SQL.  How to summarize data using SQL?  What if the query takes a long time to produce the answer?


A DW is all about getting answers to business questions, in the form of reports. Reports must communicate pertinent information clearly and concisely.

Visual Reporting Tools (no sql required)
1. Excel Pivot tables
2. PowerPivot
3. Microstrategy
4. QlinkView
5. ...

OLAP refers to the technique of performing complex business analysis over the interaction ..

Many solutions
1.  DOLAP
	1. The OLAP Client may connect to a server with multidimensional
	2. It builds a local representation (Desktop OLAP or DOLAP), which is feasible only for small data, typically single users.
2. RDBMS
	1. The software queries the data using SQL
	2. Cuboids may be already available, if not, there is a sql query to RDBMS
	3. If cuboids exists
		1. MOLAP, using MDX
		2. do not scale with very big because the cube would be too large
	4. if cuboids do not exiists
		1. ROLAP, using SQL
		2. there are ways to speed up calculations, precomputing some cuboids that are stored in the relational db (called materialized views)
	5. hybrid solution
		1. HOLAP

Third Solution.
Like Microstrategy.
We write manually SQL Queries on the relational db.

## Simple Reports with SQL

![[Pasted image 20250107162232.png]]

How to add subtotals and the grand total?

![[Pasted image 20250107163750.png]]

To avoid long UNION ALL, we use an extension of SQL called ROLLUP.
The ROLLUP calculates the subtotal by removing each time the rightmost attribute.
In general, if we have n attributes, it will generate n+1 subtotals.

![[Pasted image 20250107172103.png]]

How to produce the same report using ROLLUP?
![[Pasted image 20250107172152.png]]

*Cross-tabulation*
It cannot be achieved with ROLLUP.
It extends the ROLLUP.
The keyword is CUBE.

![[Pasted image 20250107172336.png]]

![[Pasted image 20250107172400.png]]

Here the order is not important, while it was important for the ROLLUP (?).

*Partial Rollup and Cube*
Rollup and Cube can be mixed to compute only some groupings.

![[Pasted image 20250107172724.png]]
![[Pasted image 20250107172736.png]]

## Exercises with Foodmart
> Download "Azure Data Studio"
> Use the VPN
> Add connection
> Use SQL login
> Right-click on foodmart -> new query

Let's build a standard report.

![[Pasted image 20250107173330.png]]

Adding CUBE

![[Pasted image 20250107173541.png]]

Note that, unlike standard SQL, we do not have NULL LASTS (?).

Adding CASE, with a trick to obtain the grand total.

![[Pasted image 20250107173931.png]]

Typically the order is done by the tool, do not be too worried.

![[Pasted image 20250107174055.png]]

*What if NULL is present in the data?*
How to distinguish the actual NULLs from those introduced by the ROLLUP?

Remember that with a trick in the DW design, there will not be any nulls.
There will be for instance a fictional customer called UNKNOWN with UNKNOWN values in the attributes. So there will be a foreign key pointing to that row.

We use GROUPING.

![[Pasted image 20250107174638.png]]



# dsd16 - Analytic SQL (2)

## Moderately Difficult Reports
With comparison across aggregation levels.





# dsd17- Analytic SQL (3)


# dsd18 - Query Plans


# dsd19 - DW Indexes

Start of lectures on "Relational DBMS Extensions for DW".
The topics of the lectures from 19 to 23 are
![[Pasted image 20241224104640.png]]

19 -> Index and Storage Structures + Star Query Physical Plan
20 -> Materialized Views
21 -> (functional dependencies and their usage in query optimization)
22 -> Optimization techniques for star queries with grouping and aggregations
23 -> Query rewriting to use materialized views


# dsd20




# dsd21


# dsd22


# dsd23


# dsd24


